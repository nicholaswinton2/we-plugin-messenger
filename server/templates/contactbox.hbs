<html>
  <head>
    <title>{{title}}</title>
  </head>

  <link rel="stylesheet" href="http://os.alfajango.com/css/jquery.cssemoticons.css">

  <style type="text/css">
    body {
      margin: 0px;
      font-family: "Open Sans",sans-serif;
    }

    .chat-header {
      background-color: #43a0dd;
      color: #fff;
      padding: 10px;
      font-size: 13px;
      font-weight: 700;
    }
    .chat-actions {
      background-color: #dfdfdf;
      min-height: 22px;
      font-size: 80%;
      padding: 1px 5px;
      border-bottom: 1px solid #ccc;
    }

    .chat-messages {
      list-style: none;
      margin: 0px;
      min-height: 50px;
      width: 100%;
      display: block;
      padding: 5px 0px;
      overflow-y: auto;
      background-color: #dfdfdf;
    }
    .message {
      padding: 6px;
    }

    /* Right triangle placed top left flush. */
    .talk-bubble.tri-right {
      margin-left: 32px;
      /*display: inline-block;*/
      position: relative;
      min-width: 200px;
      height: auto;
      background-color: #fff;
    }
    .tri-right.border.left-top:before {
      content: ' ';
      position: absolute;
      width: 0;
      height: 0;
      left: -40px;
      right: auto;
      top: -8px;
      bottom: auto;
      border: 32px solid;
      border-color: #666 transparent transparent transparent;
    }
    .tri-right.left-top:after{
      content: ' ';
      position: absolute;
      width: 0;
      height: 0;
      left: -15px;
      right: auto;
      top: 0px;
      bottom: auto;
      border: 15px solid;
      border-color: #fff transparent transparent transparent;
    }
    /* right triangle placed top right flush. */
    .talk-bubble.tri-left {
      margin-right: 35px;
      /*display: inline-block;*/
      position: relative;
      min-width: 200px;
      height: auto;
      background-color: #fff;
    }
    .tri-left.border.right-top:before {
      content: ' ';
      position: absolute;
      width: 0;
      height: 0;
      left: -40px;
      right: auto;
      top: auto;
      bottom: -8px;
      border: 32px solid;
      border-color: #666 transparent transparent transparent;
    }
    .tri-left.right-top:after {
      content: ' ';
      position: absolute;
      width: 0;
      height: 0;
      left: auto;
      right: -15px;
      bottom: auto;
      top: 0px;
      border: 15px solid;
      border-color: #fff transparent transparent transparent;
    }

    .message p {
      padding: 8px;
      margin: 0px;
    }

    .message img.avatar {
      float: left;
    }
    .message.current-user img.avatar{
      float: right;
    }

    .pull-right {
      float: right;
    }

    .chat-real-time-status {
      background-color: #dfdfdf;
      padding: 2px 10px;
      font-size: 0.8em;
      min-height: 20px;
    }

    #contact-is-writing {
      display: none;
    }

    .chat-form-area {
      border: 1px solid transparent;
    }

  </style>

  <body>

  <div class="chat">
    <div class="chat-header">
      <span id="#connectionStatus"></span> {{title}}
      <span class="header-actions pull-right">
        <button id="box-minimize" class="btn btn-close">-</button>
        <button id="box-close" class="btn btn-close">X</button>
      </span>
    </div>
    <div class="chat-actions">
      <span id="loadingMessages">{{{t 'messenger.loading'}}}</span>
    </div>

    <ul id="messagesList" class="chat-messages" style="height:{{height}}px;"></ul>
    <div class="chat-real-time-status">
      <span id="contact-is-writing">{{{t 'messenger.is.writing'}}}</span>
    </div>
    <div class="chat-form-area">
      {{#if isAuthenticated}}
        <form class="form-inline" id="newMessageForm" onsubmit="weChat.sendMessage();return false;">
          <div class="form-group">
              <input id="newMessageContent" name="newMessageContent" type="content" class="form-control" placeholder="New message">
              <button type="submit" class="btn btn-default">Submit</button>
          </div>
        <form>
      {{else}}
        {{!-- <a href="/login" target="_blank">Login to send messages.</a> --}}
      {{/if}}
    </div>
  </div>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment-with-locales.min.js"></script>
  <script type="text/javascript" src="/public/plugin/we-core/client/shared/libs/jquery.cssemoticons.js"></script>

  <script type="text/javascript" src="/public/plugin/we-core/client/shared/beforeAll/8_socket.io.js"></script>
  <script type="text/javascript">
    var weChat = {
      socket: null,

      user: null,
      isOnline: false,
      contact: null,

      messages: [],
      lastMessageId: 0,

      messageCount: 0,
      users: {},
      loadingUsers: {},

      showAvatar: true,
      avatarWidth: 25,

      isLoadingMore: false,
      limit: 10,
      offset: 0,

      elementList: null,

      isWritingFlag: false,
      iAmWritingFlag: false,
      writingTime: 3000,

      initialize: function initialize() {
        var self = this;

        var authToken = $.cookie('weoauth');
        var socket = this.socket;

        if (!window.contact || !window.contact.id)
          throw new Error('window.contact is required');

        self.contact = window.contact;
        self.users[window.contact.id] = window.contact;

        if (window.currentUser) {
          self.user = window.currentUser;
          self.users[window.currentUser.id] = window.currentUser;
        }

        socket = io.connect({
          query: 'authToken=' + authToken
        });

        socket.on('connect', function(){
          socket.emit('messenger:private:talk:start');
        });

        socket.on('messenger:private:message:created', function(data) {
          if (!self.messageExists(data.message.id)) {
            self.newMessage(data.message);
            self.messages.push(data.message);
            self.incrementCount();
            self.scrollToBottom();
            self.stopContactWriting();
          }
        });

        socket.on('messenger:private:is:writing', function() {
          self.contactIsWriting();
        });

        this.socket = socket;

        this.getMessagesWithUser().always(function(){
          self.scrollToBottom();
        });

        this.elementList = $('#messagesList');

        $( function ($) {
          self.elementList.bind('scroll', function() {
            if ( self.elementList.scrollTop() == 0 ) {
              self.loadMoreMessages();
            } else if (
              $(this).scrollTop() + $(this).innerHeight() >= this.scrollHeight
            ) {
              self.isScrolled = false;
            } else {
              self.isScrolled = true;
            }
          });

          $('#newMessageContent').bind('paste keyup', function() {
            self.iAmWriting();
          });
        });
      },

      startLoading: function() {
        $('#loadingMessages').show();
      },
      stopLoading: function() {
        $('#loadingMessages').hide();
      },

      contactIsWriting: function() {
        if (this.isWritingFlag) return;

        var self = this;

        $('#contact-is-writing').show();

        this.isWritingFlag = setTimeout(function() {
          $('#contact-is-writing').hide();
          self.isWritingFlag = false;
        }, this.writingTime);
      },
      stopContactWriting: function() {
        if (this.isWritingFlag) {
          self.isWritingFlag = false;
          $('#contact-is-writing').hide();
          clearTimeout(this.isWritingFlag);
        }
      },

      iAmWriting: function() {
        if (this.iAmWritingFlag) return;
        var self = this;

        this.socket.emit('messenger:private:i:am:writing', {
          toId: this.contact.id
        });

       this.iAmWritingFlag = setTimeout(function() {
          self.iAmWritingFlag = false;
        }, this.writingTime / 2);
      },

      setCount: function(count) {
        this.messageCount = count;
        $('#we-chat-message-count').text(this.messageCount);
      },

      incrementCount: function() {
        this.messageCount++;
        $('#we-chat-message-count').text(this.messageCount);
      },

      messageExists: function(id) {
        if ($('#we-chat-message-'+ id).length) return true;
        return false;
      },
      newMessage: function(message) {
        if (this.messageExists(message.id)) return;
        var self = this;
        if (!this.users[message.fromId]) {
          self.renderMessage(message, null);
          this.findUser(message.fromId, function (err, user) {
            self.users[message.fromId] = user;
            self.renderMessage(message, user);
          });
        } else {
          self.renderMessage(message, self.users[message.fromId]);
        }
      },

      renderMessage: function(message, creator) {
        var avatarTag = '';
        var isCurrentUserMessage = '';
        if (creator.id == this.user.id) isCurrentUserMessage = 'current-user';

        if (this.showAvatar) {
          avatarTag += '<img class="avatar" height="'+this.avatarWidth+'px" width="'+this.avatarWidth+'px" src="/avatar/' + message.fromId + '"> ';
        }

        position = this.getPosition(message);

        var item = '<li class="message '+ isCurrentUserMessage +'" id="we-chat-message-'+ message.id +'" data-message-id='+ message.id +' data-message-fromid'+message.fromId+'>';

        if (isCurrentUserMessage) {
          item += avatarTag;
          item += '<div class="talk-bubble tri-left right-top"><div class="talktext"><p>' +
            message.content +
          '</p></div></div>';

        } else {
          item += avatarTag;
          item += '<div class="talk-bubble tri-right left-top"><div class="talktext"><p>' +
            message.content +
          '</p></div></div>';
        }

        item += '</li>';
        this.elementList[position](item);

        $('#we-chat-message-' + message.id).emoticonize();
      },

      getPosition: function (message) {
        if (this.lastMessageId > message.id) {
          return 'prepend';
        } else {
          this.lastMessageId = message.id;
          return 'append';
        }
      },

      isScrolled: false,
      lockScroll: function lockScroll () {
        this.isScrolled = true;
      },

      scrollToBottom: function scrollToBottom() {
        var self = this;

        if (this.isScrolled) return;
        self.scrollTo( self.elementList[0].scrollHeight);
      },

      scrollTo: function scrollTo(height) {
        var self = this;
        // use one timeout to delay scroll and run after render messages inside the message box
        setTimeout(function() {
          self.elementList.scrollTop( height );
        }, 250);
      },

      sendMessage: function() {
        var self = this;
        var content = $.trim($('#newMessageContent').val());
        if (!content) return;

        $.post('/message', {
          content: content,
          toId: self.contact.id
        })
        .done(function(data) {
          self.newMessage(data.message[0]);
          self.messages.push(data.message[0]);
        })
        .fail(function() {
          alert( "error" );
        })
        .always(function() {
          $('#newMessageContent').val('');
          self.scrollToBottom();
        });

        return false;
      },
      /**
       * Get messages how authenticated user has did with user id
       */
      getMessagesWithUser: function getMessagesWithUser() {
        var self = this;

        self.startLoading();

        var self = this;
        return $.get('/message', {
          uid: self.contact.id,
          limit: self.limit,
          offset: self.offset,
          order: 'id DESC'
        })
        .done(function(data) {
          self.setCount(data.meta.count);
          for (var i = 0; i <= data.message.length-1; i++) {
            self.newMessage(data.message[i]);
            self.messages.push(data.message[i]);
          };
        })
        .fail(function() {
          alert( "error" );
        })
        .always(function() {
          self.stopLoading();
          $('#newMessageContent').val('');
        });
      },

      loadMoreMessages: function() {
        if (this.isLoadingMore) return;
        if (this.messageCount <= this.messages.length) return;

        var self = this;
        this.isLoadingMore = true;

        this.offset = this.offset + this.limit;

        var lastMessage = this.elementList.children(':first');
        //.position().top;

        this.getMessagesWithUser().always(function() {
          self.scrollTo( lastMessage.position().top );
          self.isLoadingMore = false;
        });
      },

      findUser: function(uid, cb) {
        if (this.loadingUsers[uid]) {
          this.loadingUsers[uid].done(function(data) {
            cb(null, data.user[0]);
          });
        } else {
          this.loadingUsers[uid] = $.get('/user/'+ uid)
          .done(function(data) {
            cb(null, data.user[0]);
          })
          .fail(function() {
            alert( "error" );
          });
        }
      }
    };

    window.weChat = weChat;

  </script>
  <script type="text/javascript">
    /**
     * Add Accept in all request
     *
     */
    $.ajaxPrefilter(function( options ) {
      if ( !options.beforeSend) {
        options.beforeSend = function (xhr) {
          xhr.setRequestHeader('Accept', 'application/json');

          // set auth token
          if ($.cookie('weoauth')) xhr.setRequestHeader('Authorization','Bearer ' + $.cookie('weoauth'));
        };
      }
    });

    window.moment.locale('{{locale}}');

    window.currentUser = {{{currentUserJsonRecord}}};
    window.contact = {{{jsonRecord}}};

    weChat.initialize();
  </script>
</body>
</html>